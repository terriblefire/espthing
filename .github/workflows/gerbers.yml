name: Generate Gerbers

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  gerbers:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for git rev-parse

    - name: Generate Gerber files
      run: |
        cd eagle
        make camfiles
        # Get the gerber directory name
        GERBER_DIR=$(ls -d espthing_*_*/ | head -1)
        echo "GERBER_DIR=${GERBER_DIR%/}" >> $GITHUB_ENV

    - name: Upload Gerber files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.GERBER_DIR }}
        path: eagle/${{ env.GERBER_DIR }}
        retention-days: 90

    - name: Create ZIP for release
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cd eagle
        zip -r ${{ env.GERBER_DIR }}.zip ${{ env.GERBER_DIR }}

    - name: Release Gerbers (on tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: eagle/${{ env.GERBER_DIR }}.zip
